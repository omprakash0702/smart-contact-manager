<!DOCTYPE html>
<html
  lang="en"
  th:replace="~{base :: parent(~{::#content},~{::title},~{::script})}"
>
<head>
  <title>All Your Contacts</title>
</head>

<body>
<div id="content">

  <!-- Sidebar -->
  <div th:if="${loggedInUser}">
    <div th:replace="~{user/sidebar :: sidebar}"></div>
  </div>

  <div class="sm:pl-64 pt-20 px-6">

    <h1 class="text-4xl text-center mb-2">üìí All Your Contacts</h1>
    <p class="text-center text-gray-500 mb-6">
      Manage, view or export contacts
    </p>

    <!-- SEARCH + EXPORT -->
    <div class="flex flex-wrap justify-between items-center bg-white p-4 rounded gap-4">

      <!-- üîç SEARCH -->
      <form th:object="${contactSearchForm}"
            th:action="@{'/user/contacts/search'}"
            method="get"
            class="flex flex-wrap gap-3"
            onsubmit="return validateSearchSubmit()">

        <select th:field="*{field}"
                id="searchField"
                class="border rounded px-3 py-2"
                onchange="toggleSearchBtn()">
          <option value="">Field</option>
          <option value="name">Name</option>
          <option value="phone">Phone</option>
          <option value="email">Email</option>
        </select>

        <input th:field="*{value}"
               placeholder="Search..."
               class="border rounded px-3 py-2"/>

        <button id="searchBtn"
                type="submit"
                disabled
                class="px-4 py-2 bg-gray-400 text-white rounded cursor-not-allowed">
          Search
        </button>
      </form>

      <button onclick="exportData()"
              class="px-4 py-2 bg-green-700 text-white rounded">
        ‚¨áÔ∏è Export
      </button>
    </div>

    <!-- MESSAGE -->
    <div th:replace="~{message :: messagebox}"></div>

    <!-- TABLE -->
    <div class="overflow-x-auto mt-6">

      <table id="contact-table"
             class="w-full text-sm text-left border"
             th:classappend="${pageContact.totalElements == 0} ? 'hidden' : ''">

        <thead class="bg-gray-100">
        <tr>
          <th class="px-6 py-3">Name</th>
          <th class="px-6 py-3">Phone</th>
          <th class="px-6 py-3 text-center">Edit</th>
          <th class="px-6 py-3 text-center">Delete</th>
        </tr>
        </thead>

        <tbody>
        <tr th:each="c : ${pageContact.content}"
            class="border-b hover:bg-gray-50">

          <td class="px-6 py-4">
            <div class="font-semibold" th:text="${c.name}"></div>
            <div class="text-xs italic text-gray-400"
                 th:text="${c.email ?: 'Not available'}"></div>
          </td>

          <td class="px-6 py-4 italic"
              th:text="${c.phoneNumber ?: 'Not available'}"></td>

          <!-- ‚úèÔ∏è EDIT -->
          <td class="px-6 py-4 text-center">
            <a th:href="@{'/user/contacts/view/' + ${c.id}}">‚úèÔ∏è</a>
          </td>

          <!-- üóë DELETE -->
          <td class="px-6 py-4 text-center">
            <a th:href="@{'/user/contacts/delete/' + ${c.id}}"
               onclick="return confirm('Delete this contact?')">üóë</a>
          </td>

        </tr>
        </tbody>
      </table>

      <h2 th:if="${pageContact.totalElements == 0}"
          class="text-center text-2xl p-6">
        No contacts found
      </h2>

    </div>

    <!-- PAGINATION -->
    <div th:if="${pageContact.totalPages > 1}"
         class="text-center mt-6">
      <a th:each="i : ${#numbers.sequence(0, pageContact.totalPages-1)}"
         th:href="@{'/user/contacts?page=' + ${i}}"
         th:text="${i + 1}"
         class="px-3 py-1 border mx-1 rounded"
         th:classappend="${i == pageContact.number} ? 'bg-blue-600 text-white'">
      </a>
    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@linways/table-to-excel@1.0.4/dist/tableToExcel.min.js"></script>

<script>
  function exportData() {
    const table = document.getElementById("contact-table");
    if (!table || table.classList.contains("hidden")) {
      alert("No contacts to export");
      return;
    }
    TableToExcel.convert(table, { name: "contacts.xlsx" });
  }

  function validateSearchSubmit() {
    return document.getElementById("searchField").value !== "";
  }

  function toggleSearchBtn() {
    const field = document.getElementById("searchField").value;
    const btn = document.getElementById("searchBtn");

    btn.disabled = !field;

    if (btn.disabled) {
      btn.classList.add("bg-gray-400", "cursor-not-allowed");
    } else {
      btn.classList.remove("bg-gray-400", "cursor-not-allowed");
    }
  }

  document.addEventListener("DOMContentLoaded", toggleSearchBtn);
</script>

</body>
</html>
